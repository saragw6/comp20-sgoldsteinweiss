<!DOCTYPE html>
<html>
	<head>
		<title>MapChat</title>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<script src="https://maps.google.com/maps/api/js?sensor=true"></script>
		<!-- this might go here: <script src="https://secret-about-box.herokuapp.com/sendLocation"></script> -->
		<link rel="stylesheet" href="style.css">
		<script>
			function init() {

				if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
					navigator.geolocation.getCurrentPosition(function(position) {
						//Getting user's location
						myLat = position.coords.latitude;
						myLng = position.coords.longitude;
						sendLocation(myLat, myLng);
					});
				}
				else {
					alert("Geolocation is not supported by your web browser.  What a shame!");
				}
			}
						
			function sendLocation(Lat, Lng) {
				var http = new XMLHttpRequest();
				http.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
				http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				http.onreadystatechange = function() {if(http.readyState == 4 && http.status == 200) {
					jsondata = http.responseText;
					console.log(jsondata);
					parsedObjects = JSON.parse(jsondata);
				}
				http.send("login=TomDapper&lat=" + Lat + "&lng=" + Lng + "&message=Hello");
				renderMap(parsedObjects);
			};
			}

			function dist (lat, lng) {
				// Converts from degrees to radians. (taken from http://cwestblog.com/2012/11/12/javascript-degree-and-radian-conversion/)
				Math.radians = function(degrees) {
				  return (degrees * Math.PI / 180);
				};
				 
				// Converts from radians to degrees.
				Math.degrees = function(radians) {
				  return (radians * 180 / Math.PI);
				};

				var R = 3959; // miles
				var φ1 = Math.radians(myLat);
				var φ2 = Math.radians(lat);
				var Δφ = Math.radians((lat-myLat));
				var Δλ = Math.radians((lng-myLng));

				var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
				        Math.cos(φ1) * Math.cos(φ2) *
				        Math.sin(Δλ/2) * Math.sin(Δλ/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

				return (R * c);
			}

			function renderMap(parsedObjects) {
				var map = new google.maps.Map(document.getElementById('map_canvas'), {
		    		center: {lat: 42.4, lng: -71.1},
		    		zoom: 12
		 		});


				//setting markers
				for (count = 1; count < parsedObjects.length; count++) {
					var distance = dist(parsedObjects[count]["lat"], parsedObjects[count]["lng"]);

					var myMarker = new google.maps.Marker({
						position: {lat: parsedObjects[count]["lat"], lng: parsedObjects[count]["lng"]},
							map: map,
							title: parsedObjects[count]["login"] + ". " + distance + " miles away. " + parsedObjects[count]["message"] + "."
					});

					// Open info window on click of marker
					google.maps.event.addListener(myMarker, 'click', function() {
						infowindow.setContent(myMarker.title);
						infowindow.open(map, myMarker);
					});
					console.log("for function complete");
				}

				//setting unique marker
				var myMarker = new google.maps.Marker({
					position: {lat: myLat, lng: myLng},
					map: map,
					icon: "pushpin.png",
						title: "Here's you, TomDapper."
				});
			}
		</script>	
	</head>

	<body onload="init()">
		<div id="map_canvas"></div>
	</body>
</html>